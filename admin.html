<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜æ§åˆ¶å° - æ¨¡æ‹Ÿäº¤æ˜“å¹³å°</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .login-section {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }
        
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            color: #666;
            font-weight: bold;
        }
        
        .status-value {
            color: #333;
        }
        
        .status-value.running {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-value.waiting {
            color: #ffc107;
            font-weight: bold;
        }
        
        .status-value.countdown {
            color: #dc3545;
            font-weight: bold;
            font-size: 18px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .control-section {
            display: none;
        }
        
        .control-section.active {
            display: block;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .info-box p {
            margin: 5px 0;
            color: #1976D2;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç®¡ç†å‘˜æ§åˆ¶å°</h1>
        <p class="subtitle">æ¨¡æ‹Ÿäº¤æ˜“å¹³å°ç®¡ç†</p>
        
        <div id="alert" class="alert"></div>
        
        <!-- ç™»å½•åŒºåŸŸ -->
        <div id="login-section" class="login-section">
            <div class="form-group">
                <label for="password">ç®¡ç†å‘˜å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " autofocus>
            </div>
            <button class="btn btn-primary" onclick="adminLogin()">ç™»å½•</button>
        </div>
        
        <!-- æ§åˆ¶åŒºåŸŸ -->
        <div id="control-section" class="control-section">
            <div class="info-box">
                <p><strong>å½“å‰çŠ¶æ€ï¼š</strong><span id="game-status">ç­‰å¾…ä¸­</span></p>
                <p><strong>åœ¨çº¿ç”¨æˆ·ï¼š</strong><span id="online-count">0</span> äºº</p>
                <p><strong>æ¸¸æˆæ—¶é—´ï¼š</strong><span id="time-left">280</span> ç§’</p>
            </div>
            
            <div class="status-panel">
                <div class="status-item">
                    <span class="status-label">æ¸¸æˆçŠ¶æ€</span>
                    <span class="status-value" id="status-display">ç­‰å¾…å¼€å§‹</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å€’è®¡æ—¶</span>
                    <span class="status-value" id="countdown-display">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å¸‚åœºä»·æ ¼</span>
                    <span class="status-value" id="market-price">500</span>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-success" id="btn-start" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
                <button class="btn btn-danger" id="btn-reset" onclick="resetGame()">é‡ç½®æ¸¸æˆ</button>
                <button class="btn btn-primary" id="btn-export" onclick="exportData()" style="background: #17a2b8;">å¯¼å‡ºæ•°æ®</button>
            </div>
        </div>
    </div>
    
    <script>
        let socket = null;
        let isAdmin = false;
        
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }
        
        function initSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
            });
            
            socket.on('admin_login_success', () => {
                isAdmin = true;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('control-section').classList.add('active');
                showAlert('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ', 'success');
            });
            
            socket.on('admin_login_failed', (data) => {
                showAlert(data.message || 'å¯†ç é”™è¯¯', 'danger');
            });
            
            socket.on('state_update', (state) => {
                updateStatus(state);
            });
            
            socket.on('admin_reset_success', () => {
                showAlert('æ¸¸æˆå·²é‡ç½®', 'success');
            });
            
            socket.on('error', (data) => {
                showAlert(data.message || 'æ“ä½œå¤±è´¥', 'danger');
            });
            
            socket.on('admin_export_data', (data) => {
                handleExportData(data);
            });
        }
        
        function adminLogin() {
            const password = document.getElementById('password').value;
            if (!password) {
                showAlert('è¯·è¾“å…¥å¯†ç ', 'danger');
                return;
            }
            
            if (socket && socket.connected) {
                socket.emit('admin_login', { password: password });
            } else {
                showAlert('æœªè¿æ¥åˆ°æœåŠ¡å™¨', 'danger');
            }
        }
        
        function startGame() {
            if (!isAdmin) {
                showAlert('è¯·å…ˆç™»å½•', 'danger');
                return;
            }
            
            socket.emit('admin_start_game');
        }
        
        function resetGame() {
            if (!isAdmin) {
                showAlert('è¯·å…ˆç™»å½•', 'danger');
                return;
            }
            
            if (confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰ç”¨æˆ·çš„äº¤æ˜“æ•°æ®ã€‚')) {
                socket.emit('admin_reset_game');
            }
        }
        
        function exportData() {
            if (!isAdmin) {
                showAlert('è¯·å…ˆç™»å½•', 'danger');
                return;
            }
            
            socket.emit('admin_export_data');
            showAlert('æ­£åœ¨å¯¼å‡ºæ•°æ®...', 'success');
        }
        
        function handleExportData(data) {
            // ç”ŸæˆCSVæ ¼å¼çš„æ•°æ®
            let csvContent = '';
            
            // æ¸¸æˆä¿¡æ¯
            csvContent += 'æ¸¸æˆä¿¡æ¯\n';
            csvContent += `å¼€å§‹æ—¶é—´,${data.game_info.start_time || 'N/A'}\n`;
            csvContent += `æ¸¸æˆæ—¶é•¿,${data.game_info.duration}ç§’\n`;
            csvContent += `æœ€ç»ˆå†…åœ¨ä»·å€¼,${data.game_info.final_fundamental_value}\n`;
            csvContent += `æ¸¸æˆçŠ¶æ€,${data.game_info.is_completed ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}\n`;
            csvContent += '\n';
            
            // ç”¨æˆ·æ±‡æ€»æ•°æ®
            csvContent += 'ç”¨æˆ·æ±‡æ€»æ•°æ®\n';
            csvContent += 'ç”¨æˆ·ID,æ˜µç§°,æ€»ä¹°å…¥,æ€»å–å‡º,å‡€äº¤æ˜“,å¹³å‡æˆæœ¬,æœ€ç»ˆæŒä»“,æœ€ç»ˆç°é‡‘,æœ€ç»ˆè´¢å¯Œ\n';
            data.users.forEach(user => {
                const stats = user.final_stats;
                csvContent += `${user.user_id},${user.name},${stats.total_buys},${stats.total_sells},${stats.net_transactions},${stats.avg_price.toFixed(3)},${stats.demand},${stats.cash.toFixed(2)},${stats.final_wealth.toFixed(2)}\n`;
            });
            csvContent += '\n';
            
            // è¯¦ç»†äº¤æ˜“è®°å½•
            csvContent += 'è¯¦ç»†äº¤æ˜“è®°å½•\n';
            csvContent += 'ç”¨æˆ·ID,æ˜µç§°,æ¸¸æˆæ—¶é—´(ç§’),å®é™…æ—¶é—´,æ“ä½œ,æ•°é‡,æ‰§è¡Œä»·æ ¼,å¸‚åœºä»·æ ¼,æŒä»“å‰,æŒä»“å\n';
            data.users.forEach(user => {
                user.trade_history.forEach(trade => {
                    csvContent += `${user.user_id},${user.name},${trade.time},${trade.timestamp},${trade.action},${trade.quantity},${trade.price},${trade.market_price},${trade.demand_before},${trade.demand_after}\n`;
                });
            });
            
            // ä¸‹è½½CSVæ–‡ä»¶
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `äº¤æ˜“æ•°æ®_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
        }
        
        function updateStatus(state) {
            document.getElementById('online-count').textContent = state.online_count || 0;
            document.getElementById('time-left').textContent = state.time_left || 280;
            document.getElementById('market-price').textContent = state.market_price || 500;
            
            const statusDisplay = document.getElementById('status-display');
            const countdownDisplay = document.getElementById('countdown-display');
            const btnStart = document.getElementById('btn-start');
            
            if (state.is_running) {
                statusDisplay.textContent = 'æ¸¸æˆä¸­';
                statusDisplay.className = 'status-value running';
                countdownDisplay.textContent = '-';
                btnStart.disabled = true;
            } else if (state.is_countdown) {
                statusDisplay.textContent = 'å€’è®¡æ—¶ä¸­';
                statusDisplay.className = 'status-value countdown';
                countdownDisplay.textContent = state.countdown || 0;
                btnStart.disabled = true;
            } else {
                statusDisplay.textContent = 'ç­‰å¾…å¼€å§‹';
                statusDisplay.className = 'status-value waiting';
                countdownDisplay.textContent = '-';
                btnStart.disabled = false;
            }
            
            document.getElementById('game-status').textContent = 
                state.is_running ? 'æ¸¸æˆä¸­' : 
                state.is_countdown ? `å€’è®¡æ—¶ ${state.countdown}ç§’` : 
                'ç­‰å¾…å¼€å§‹';
        }
        
        // æ”¯æŒå›è½¦é”®ç™»å½•
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                adminLogin();
            }
        });
        
        // åˆå§‹åŒ–
        initSocket();
    </script>
</body>
</html>

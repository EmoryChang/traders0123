<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人实时模拟交易平台</title>
    <!-- Socket.IO 客户端库 -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root {
            --bg-color: #d4d0c8; /* Windows 2000 style grey */
            --panel-bg: #ffffff;
            --border-dark: #404040;
            --border-light: #ffffff;
            --text-color: #000000;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 15px;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
            box-sizing: border-box;
        }

        /* Main Container */
        #app-container {
            width: 1100px;
            height: 800px;
            background-color: var(--bg-color);
            border: 2px solid var(--border-dark);
            border-left-color: var(--border-light);
            border-top-color: var(--border-light);
            display: grid;
            grid-template-rows: 230px 1fr; /* Row 1: Stats, Row 2: Chart */
            grid-template-columns: 220px 1fr 280px; /* Col 1: Controls, Col 2: Mid, Col 3: Right */
            gap: 8px;
            padding: 8px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
        }

        /* --- UTILITY CLASSES --- */
        .panel {
            background: var(--panel-bg);
            border: 1px solid #808080;
            padding: 8px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .header {
            font-size: 13px;
            font-weight: bold;
            text-decoration: underline;
            margin-bottom: 5px;
            color: #000;
        }
        .bold { font-weight: bold; }
        
        /* --- LEFT COLUMN: CONTROLS (FULL HEIGHT) --- */
        #col-controls {
            grid-row: 1 / span 2; 
            grid-column: 1;
            background: var(--bg-color);
            border: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-bottom: 10px; 
        }

        #timer-box {
            background: white;
            border: 2px inset #fff;
            font-family: 'Courier New', monospace;
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            padding: 10px 0;
            color: black;
        }
        .timer-label { font-size: 12px; text-align: center; margin-top: -5px; }

        .btn-group { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            margin-top: 20px;
        }
        
        button.trade-btn {
            background: var(--bg-color);
            border: 2px outset #fff;
            border-right-color: var(--border-dark);
            border-bottom-color: var(--border-dark);
            padding: 15px; 
            font-size: 18px; 
            font-weight: bold;
            cursor: pointer;
            font-family: 'Times New Roman', serif;
        }
        button.trade-btn:active {
            border-style: inset;
            transform: translate(1px, 1px);
        }

        /* --- TOP MID: DASHBOARD --- */
        #col-dashboard {
            grid-row: 1;
            grid-column: 2;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        table.stats { width: 100%; border-collapse: collapse; font-size: 12px; }
        table.stats th { text-align: center; font-weight: normal; border-bottom: 1px solid #000; padding-bottom: 2px; }
        table.stats td { text-align: right; padding: 3px 5px; }
        table.stats td:first-child { text-align: left; }

        #price-display {
            font-size: 40px;
            font-weight: bold;
            text-align: center;
            border: 1px solid #aaa;
            background: #fff;
            padding: 8px;
            margin: 10px 0;
            font-family: Arial, sans-serif;
        }

        /* --- TOP RIGHT: RISK --- */
        #col-risk {
            grid-row: 1;
            grid-column: 3;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 15px;
            line-height: 1.4;
        }
        
        #risk-msg-default {
            font-size: 13px;
            color: black;
            font-weight: bold;
        }

        #risk-msg-alert {
            display: none;
            color: red;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            border: 2px solid red;
            padding: 5px;
            background: #ffe6e6;
            margin-top: 10px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 1000;
        }
        .connection-status.connected {
            background: #4CAF50;
            color: white;
        }
        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }
        .connection-status.connecting {
            background: #ff9800;
            color: white;
        }

        /* 用户昵称输入对话框 */
        #username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        #username-modal.hidden {
            display: none !important;
        }
        #username-dialog {
            background: white;
            padding: 30px;
            border: 3px solid #000;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            text-align: center;
            min-width: 300px;
        }
        #username-dialog h3 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        #username-input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #000;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        #username-submit {
            padding: 10px 30px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        #username-submit:hover {
            background: #45a049;
        }

        /* 在线用户信息 */
        #online-info {
            position: fixed;
            top: 50px;
            right: 10px;
            background: white;
            border: 2px solid #000;
            padding: 8px;
            font-size: 12px;
            max-width: 180px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 999;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.3);
        }
        #online-info .header {
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
        }
        .user-item {
            padding: 3px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: flex-start;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .user-name {
            font-weight: normal;
            font-size: 11px;
        }

        /* --- BOTTOM: CHART (WIDE, RIGHT SIDE) --- */
        #col-chart {
            grid-row: 2;
            grid-column: 2 / span 2; 
            display: flex;
            flex-direction: column;
            background: white;
            border: 1px solid #000;
            padding: 5px;
        }

        .chart-controls {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
            background: #eee;
            padding: 4px;
            border-bottom: 1px solid #ccc;
        }
        
        .chart-controls button {
            font-size: 11px;
            cursor: pointer;
            padding: 2px 8px;
            min-width: 30px;
        }

        #chart-wrapper {
            flex-grow: 1;
            position: relative;
            width: 100%;
            overflow: hidden;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

    </style>
</head>
<body>
    <!-- 用户昵称输入对话框 -->
    <div id="username-modal">
        <div id="username-dialog">
            <h3>请输入您的昵称</h3>
            <input type="text" id="username-input" placeholder="例如: 交易员001" maxlength="20" autofocus>
            <button id="username-submit" onclick="submitUsername()">确定</button>
        </div>
    </div>

    <div id="connection-status" class="connection-status connecting">连接中...</div>
    <div id="online-info">
        <div class="header">在线用户 (<span id="online-count">0</span>)</div>
        <div id="user-list">等待连接...</div>
    </div>

<div id="app-container">
    
    <!-- 1. CONTROLS (Now Full Height) -->
    <div id="col-controls">
        <div>
            <div id="timer-box">等待开始</div>
            <div class="timer-label" id="timer-label">seconds</div>
        </div>
        <div class="btn-group">
            <button class="trade-btn" onclick="userTrade(2)">BUY 2</button>
            <button class="trade-btn" onclick="userTrade(1)">BUY 1</button>
            <div style="height: 40px;"></div> <!-- Fixed Spacer -->
            <button class="trade-btn" onclick="userTrade(-1)">SELL 1</button>
            <button class="trade-btn" onclick="userTrade(-2)">SELL 2</button>
        </div>
    </div>

    <!-- 2. DASHBOARD -->
    <div id="col-dashboard">
        <!-- Trading Activity -->
        <div class="panel">
            <div class="header">Trading Activity</div>
            <table class="stats">
                <tr><th></th><th>YOU</th><th>ALL USERS</th><th>MARKET</th></tr>
                <tr><td>Buys</td><td id="u-buys">0</td><td id="all-buys">0</td><td id="m-buys">0</td></tr>
                <tr><td>Sells</td><td id="u-sells">0</td><td id="all-sells">0</td><td id="m-sells">0</td></tr>
                <tr style="border-top: 1px solid #888">
                    <td>Net Transactions</td>
                    <td id="u-net" class="bold">0</td>
                    <td id="all-net" class="bold">0</td>
                    <td id="m-net" class="bold">0</td>
                </tr>
            </table>
            
            <div style="margin-top: auto; text-align:center;">
                <div style="font-size: 12px; font-weight: bold;">Current Market Price</div>
                <div id="price-display">500</div>
            </div>
        </div>

        <!-- Financial Measures -->
        <div class="panel">
            <div class="header">Financial Measures</div>
            <table class="stats">
                <tr><th></th><th>SHARES</th><th>DOLLARS</th></tr>
                <tr>
                    <td id="lbl-avg-cost">Average Share Cost</td>
                    <td></td>
                    <td id="val-avg-cost">0.000</td>
                </tr>
                <tr>
                    <td>Realized Gain/Loss</td>
                    <td></td>
                    <td id="val-realized">0</td>
                </tr>
                <tr>
                    <td>Unrealized Gain/Loss</td>
                    <td></td>
                    <td id="val-unrealized">0</td>
                </tr>
                <tr>
                    <td>Share Exposure</td>
                    <td id="val-exposure" class="bold">0</td>
                    <td></td>
                </tr>
            </table>
        </div>
    </div>

    <!-- 3. RISK -->
    <div id="col-risk" class="panel">
        <div id="risk-msg-default">
            The Unrealized Loss Limit is 500. If your unrealized loss exceeds 500, your shares will be liquidated.
        </div>
        <div id="risk-msg-alert">
            WARNING:<br>LIMIT EXCEEDED<br>LIQUIDATED
        </div>
    </div>

    <!-- 4. CHART (WIDE, RIGHT) -->
    <div id="col-chart">
        <div class="chart-controls">
            <span>Zoom:</span>
            <button onclick="setZoom(1)">1s</button>
            <button onclick="setZoom(2)">2s</button>
            <button onclick="setZoom(5)">5s</button>
            <button onclick="setZoom(10)">10s</button>
            <button onclick="setZoom(20)">20s</button>
            <button onclick="setZoom('all')">All</button>
        </div>
        <div id="chart-wrapper">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

</div>

<script>
// --- CONFIGURATION ---
const LOSS_LIMIT = 500;
let zoomWindow = 20; // Default zoom set to 20s

// --- STATE VARIABLES ---
let socket = null;
let timeLeft = 280;
let timeElapsed = 0;
let isRunning = false;
let myUsername = '';
let usernameSet = false;

// Market Data
let marketPrice = 500;
let fundamentalValue = 500;

// User Portfolio (本地用户)
let userDemand = 0;
let userCash = 0;
let avgSharePrice = 0;
let userBuys = 0;
let userSells = 0;

// Market Statistics
let marketBuys = 0;
let marketSells = 0;
let totalUserBuys = 0;
let totalUserSells = 0;

// Online Users
let onlineUsers = [];
let onlineCount = 0;

// Chart Data
let history = [];

// --- SOCKET.IO 连接 ---
function initSocket() {
    socket = io();
    
    const statusEl = document.getElementById('connection-status');
    
    socket.on('connect', () => {
        console.log('已连接到服务器');
        statusEl.textContent = '已连接';
        statusEl.className = 'connection-status connected';
        
        // 显示用户名输入对话框
        if (!usernameSet) {
            document.getElementById('username-modal').classList.remove('hidden');
            document.getElementById('username-input').focus();
        }
    });
    
    socket.on('disconnect', () => {
        console.log('与服务器断开连接');
        statusEl.textContent = '已断开';
        statusEl.className = 'connection-status disconnected';
    });
    
    socket.on('connect_error', () => {
        console.log('连接错误');
        statusEl.textContent = '连接失败';
        statusEl.className = 'connection-status disconnected';
    });
    
    // 接收状态更新
    socket.on('state_update', (state) => {
        timeLeft = state.time_left;
        timeElapsed = state.time_elapsed;
        marketPrice = state.market_price;
        fundamentalValue = state.fundamental_value;
        marketBuys = state.market_buys;
        marketSells = state.market_sells;
        totalUserBuys = state.total_user_buys;
        totalUserSells = state.total_user_sells;
        // 更新历史数据（确保是数组）
        if (state.history && Array.isArray(state.history) && state.history.length > 0) {
            history = state.history;
            console.log('历史数据更新:', history.length, '个数据点');
        } else if (state.history && Array.isArray(state.history)) {
            history = state.history; // 即使是空数组也更新
        }
        // 如果history为空，保持现有数据（不覆盖）
        
        // 更新游戏状态
        isRunning = state.is_running || false;
        const isCountdown = state.is_countdown || false;
        const countdown = state.countdown || 0;
        const waitingForAdmin = state.waiting_for_admin || false;
        
        // 更新在线用户信息
        onlineCount = state.online_count || 0;
        onlineUsers = state.online_users || [];
        
        // 更新本地用户数据（如果存在）
        if (state.users && socket.id && state.users[socket.id]) {
            const myData = state.users[socket.id];
            userDemand = myData.demand;
            userBuys = myData.buys;
            userSells = myData.sells;
            avgSharePrice = myData.avg_price;
            if (myData.name) {
                myUsername = myData.name;
            }
            
            // 计算现金（从已实现盈亏反推）
            const totalEquity = myData.realized + myData.unrealized;
            userCash = totalEquity - (userDemand * marketPrice);
        }
        
        // 更新UI（包括图表）
        updateUI(isCountdown, countdown, waitingForAdmin);
        updateOnlineUsers();
        
        // 强制更新图表（确保实时显示）- 每次状态更新都重新绘制
        requestAnimationFrame(() => {
            drawChart();
        });
    });
    
    // 用户名设置成功
    socket.on('username_set', (data) => {
        myUsername = data.name;
        usernameSet = true;
        const modal = document.getElementById('username-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    });
    
    // 风险平仓通知
    socket.on('risk_liquidated', (data) => {
        if (data.user_id === socket.id) {
            const defaultMsg = document.getElementById('risk-msg-default');
            const alertMsg = document.getElementById('risk-msg-alert');
            defaultMsg.style.display = 'none';
            alertMsg.style.display = 'block';
            setTimeout(() => {
                defaultMsg.style.display = 'block';
                alertMsg.style.display = 'none';
            }, 3000);
        }
    });
    
    // 游戏结束
    socket.on('game_ended', (data) => {
        isRunning = false;
        const myResult = data.results[socket.id];
        if (myResult) {
            alert(`实验结束。\n\n清算股息（内在价值）: ${data.fundamental_value}\n\n您的最终财富: ${myResult.final_wealth.toFixed(2)}`);
        }
    });
    
    socket.on('error', (data) => {
        alert('错误: ' + data.message);
    });
}

// --- USER TRADING LOGIC ---
function userTrade(qty) {
    if (!socket || !socket.connected) {
        alert('未连接到服务器');
        return;
    }
    
    if (!usernameSet) {
        alert('请先设置您的昵称');
        const modal = document.getElementById('username-modal');
        if (modal) {
            modal.classList.remove('hidden');
        }
        return;
    }
    
    if (!isRunning) {
        alert('游戏尚未开始，请等待倒计时结束');
        return;
    }
    
    // 发送交易请求到服务器
    socket.emit('user_trade', { qty: qty });
}

// --- 用户名设置 ---
function submitUsername() {
    const input = document.getElementById('username-input');
    const username = input.value.trim();
    
    if (username && socket && socket.connected) {
        socket.emit('set_username', { name: username });
    } else if (!socket || !socket.connected) {
        alert('请等待连接建立');
    }
}

// 支持回车键提交
document.addEventListener('DOMContentLoaded', () => {
    const usernameInput = document.getElementById('username-input');
    if (usernameInput) {
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitUsername();
            }
        });
    }
});

// --- 更新在线用户列表 ---
function updateOnlineUsers() {
    const onlineInfo = document.getElementById('online-info');
    const onlineCountEl = document.getElementById('online-count');
    const userListEl = document.getElementById('user-list');
    
    // 始终显示在线用户面板
    onlineInfo.style.display = 'block';
    onlineCountEl.textContent = onlineCount || 0;
    
    if (onlineCount > 0 && onlineUsers.length > 0) {
        // 只显示用户昵称列表，不显示交易情况
        let html = '';
        onlineUsers.forEach((user) => {
            const isMe = user.id === socket.id;
            html += `<div class="user-item" style="${isMe ? 'background: #e3f2fd; font-weight: bold;' : ''}">
                <span class="user-name">${user.name}${isMe ? ' (我)' : ''}</span>
            </div>`;
        });
        userListEl.innerHTML = html || '暂无数据';
    } else {
        userListEl.innerHTML = '等待用户加入...';
    }
}

function calculateUnrealizedPL() {
    if (userDemand === 0 || avgSharePrice === 0) return 0;
    return userDemand * (marketPrice - avgSharePrice);
}

// --- UI UPDATES ---
function updateUI(isCountdown = false, countdown = 0, waitingForAdmin = false) {
    // Timer - 显示倒计时或游戏时间
    const timerBox = document.getElementById('timer-box');
    const timerLabel = document.getElementById('timer-label');
    
    if (isCountdown) {
        timerBox.innerText = countdown;
        timerBox.style.color = '#ff0000';
        timerBox.style.fontSize = '60px';
        timerLabel.innerText = '准备开始';
    } else if (isRunning) {
        timerBox.innerText = timeLeft;
        timerBox.style.color = 'black';
        timerBox.style.fontSize = '48px';
        timerLabel.innerText = 'seconds';
    } else if (waitingForAdmin) {
        timerBox.innerText = '等待';
        timerBox.style.color = '#ff9800';
        timerBox.style.fontSize = '48px';
        timerLabel.innerText = '等待管理员启动';
    } else {
        timerBox.innerText = '等待开始';
        timerBox.style.color = '#666';
        timerBox.style.fontSize = '48px';
        timerLabel.innerText = '等待中';
    }

    // Activity - 本地用户
    document.getElementById('u-buys').innerText = userBuys;
    document.getElementById('u-sells').innerText = userSells;
    document.getElementById('u-net').innerText = userBuys - userSells;
    
    // Activity - 所有用户
    document.getElementById('all-buys').innerText = totalUserBuys;
    document.getElementById('all-sells').innerText = totalUserSells;
    document.getElementById('all-net').innerText = totalUserBuys - totalUserSells;
    
    // Activity - 市场（机器人）
    document.getElementById('m-buys').innerText = Math.floor(marketBuys);
    document.getElementById('m-sells').innerText = Math.floor(marketSells);
    document.getElementById('m-net').innerText = Math.floor(marketBuys - marketSells);

    // Price
    document.getElementById('price-display').innerText = marketPrice;

    // Financials
    let unrealized = calculateUnrealizedPL();
    let totalEquity = userCash + (userDemand * marketPrice);
    let realized = totalEquity - unrealized;
    
    // Dynamic Label
    let avgLabel = document.getElementById('lbl-avg-cost');
    if (userDemand < 0) avgLabel.innerText = "Average Share Revenue";
    else avgLabel.innerText = "Average Share Cost";

    document.getElementById('val-avg-cost').innerText = Math.abs(avgSharePrice).toFixed(3);
    document.getElementById('val-realized').innerText = realized.toFixed(0);
    document.getElementById('val-unrealized').innerText = unrealized.toFixed(0);
    document.getElementById('val-exposure').innerText = userDemand;
    
    // 检查风险显示
    const defaultMsg = document.getElementById('risk-msg-default');
    const alertMsg = document.getElementById('risk-msg-alert');
    if (unrealized < -LOSS_LIMIT) {
        defaultMsg.style.display = 'none';
        alertMsg.style.display = 'block';
    } else {
        defaultMsg.style.display = 'block';
        alertMsg.style.display = 'none';
    }

    drawChart();
}

// --- CHART ENGINE ---
function setZoom(seconds) {
    zoomWindow = seconds;
    drawChart();
}

function drawChart() {
    const canvas = document.getElementById('mainChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    
    const parent = canvas.parentElement;
    if (!parent) return;
    
    canvas.width = parent.clientWidth;
    canvas.height = parent.clientHeight;
    
    const W = canvas.width;
    const H = canvas.height;
    
    if (W === 0 || H === 0) return;

    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, W, H);

    if (!history || history.length === 0) {
        // 显示提示信息
        ctx.fillStyle = "#999";
        ctx.font = "16px Arial";
        ctx.textAlign = "center";
        ctx.fillText("等待游戏开始...", W / 2, H / 2);
        return;
    }
    
    console.log('绘制图表，数据点数量:', history.length);

    let data = history;
    if (zoomWindow !== 'all') {
        let startIndex = Math.max(0, history.length - zoomWindow);
        data = history.slice(startIndex);
    }
    if (data.length === 0) return;

    // Layout
    const pad = { top: 20, right: 50, bottom: 20, left: 10 };
    const plotW = W - pad.left - pad.right;
    
    const hPrice = H * 0.65;
    const hVol = H * 0.20;
    const hSpread = H * 0.15;
    
    const yPriceBase = hPrice;
    const yVolBase = hPrice + hVol;
    const ySpreadBase = H;

    // Scales
    let minP = Infinity, maxP = -Infinity;
    let maxV = 0;
    data.forEach(d => {
        if (d.p < minP) minP = d.p;
        if (d.p > maxP) maxP = d.p;
        let totalVol = d.volBuy + d.volSell;
        if (totalVol > maxV) maxV = totalVol;
    });
    
    // UPDATED: No minimum range enforcement.
    // Just ensure max > min to avoid division by zero
    if (maxP === minP) {
        minP -= 1;
        maxP += 1;
    }

    // Add small 5% padding so line doesn't hit the exact edge
    let pRange = maxP - minP;
    minP -= pRange * 0.05;
    maxP += pRange * 0.05;
    
    const getY_Price = (p) => yPriceBase - ((p - minP) / (maxP - minP)) * (hPrice - pad.top);
    
    if (maxV === 0) maxV = 5;
    
    const getX = (i) => pad.left + (i / (data.length - 1 || 1)) * plotW;

    // --- 1. PRICE ---
    ctx.strokeStyle = "#e0e0e0";
    ctx.lineWidth = 1;
    ctx.beginPath();
    
    // Grid lines - dynamic step based on range
    let pStep = Math.max(1, Math.ceil((maxP - minP) / 5));
    
    for (let p = Math.ceil(minP); p <= maxP; p += pStep) {
        let y = getY_Price(p);
        ctx.moveTo(pad.left, y);
        ctx.lineTo(pad.left + plotW, y);
        ctx.fillStyle = "#666";
        ctx.font = "11px Arial";
        ctx.fillText(p, pad.left + plotW + 5, y + 4);
    }
    ctx.stroke();

    // 绘制价格曲线
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.beginPath();
    let pathStarted = false;
    data.forEach((d, i) => {
        if (d && typeof d.p === 'number' && !isNaN(d.p)) {
            let x = getX(i);
            let y = getY_Price(d.p);
            if (!pathStarted) {
                ctx.moveTo(x, y);
                pathStarted = true;
            } else {
                ctx.lineTo(x, y);
            }
        }
    });
    if (pathStarted) {
        ctx.stroke();
        console.log('价格曲线已绘制，数据点:', data.length);
    } else {
        console.warn('没有有效数据点可以绘制');
    }
    
    ctx.strokeStyle = "#888";
    ctx.strokeRect(pad.left, 0, plotW, hPrice);

    // --- 2. VOLUME (STACKED) ---
    ctx.fillStyle = "#000";
    ctx.font = "bold 10px Arial";
    ctx.fillText("Volume", pad.left + 5, yPriceBase + 12);

    // Legend for Volume
    ctx.fillStyle = "#444"; // Buys
    ctx.fillRect(pad.left + 50, yPriceBase + 5, 8, 8);
    ctx.fillStyle = "#aaa"; // Sells
    ctx.fillRect(pad.left + 90, yPriceBase + 5, 8, 8);
    ctx.fillStyle = "#000";
    ctx.font = "9px Arial";
    ctx.fillText("Buy", pad.left + 60, yPriceBase + 12);
    ctx.fillText("Sell", pad.left + 100, yPriceBase + 12);

    let barWidth = (plotW / data.length) * 0.8;
    
    data.forEach((d, i) => {
        let totalVol = d.volBuy + d.volSell;
        if (totalVol > 0) {
            let x = getX(i);
            // Height proportional to total volume
            let hTotal = (totalVol / maxV) * (hVol - 15);
            
            let hBuy = (d.volBuy / totalVol) * hTotal;
            let hSell = (d.volSell / totalVol) * hTotal;
            
            let yBottom = yVolBase;
            
            // Draw Buy (Darker)
            if (hBuy > 0) {
                ctx.fillStyle = "#444";
                ctx.fillRect(x - barWidth/2, yBottom - hBuy, barWidth, hBuy);
            }
            // Draw Sell (Lighter) on top of Buy
            if (hSell > 0) {
                ctx.fillStyle = "#bbb";
                ctx.fillRect(x - barWidth/2, yBottom - hBuy - hSell, barWidth, hSell);
            }
        }
    });
    ctx.strokeStyle = "#ccc";
    ctx.strokeRect(pad.left, yPriceBase, plotW, hVol);

    // --- 3. SPREAD ---
    ctx.fillStyle = "#000";
    ctx.font = "10px Arial";
    ctx.fillText("Spread (Fixed: 2)", pad.left + 5, yVolBase + 12);
    
    let ySpreadMid = yVolBase + (hSpread / 2);
    ctx.strokeStyle = "#888";
    ctx.beginPath();
    ctx.moveTo(pad.left, ySpreadMid - 5);
    ctx.lineTo(pad.left + plotW, ySpreadMid - 5);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(pad.left, ySpreadMid + 5);
    ctx.lineTo(pad.left + plotW, ySpreadMid + 5);
    ctx.stroke();
    
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";
    let tStep = Math.ceil(data.length / 8);
    data.forEach((d, i) => {
        if (i % tStep === 0) {
            let x = getX(i);
            ctx.fillText(d.t, x, H - 5);
            ctx.beginPath();
            ctx.moveTo(x, H - 15);
            ctx.lineTo(x, H - 20);
            ctx.stroke();
        }
    });

    ctx.strokeStyle = "#ccc";
    ctx.strokeRect(pad.left, yVolBase, plotW, hSpread - 20);
}

// --- INITIALIZATION ---
function init() {
    // 确保用户名输入框默认显示
    const modal = document.getElementById('username-modal');
    if (modal) {
        modal.classList.remove('hidden');
    }
    
    initSocket();
    
    // 初始绘制空图表
    setTimeout(() => {
        drawChart();
    }, 100);
    
    // 窗口大小变化时重新绘制图表
    window.addEventListener('resize', () => {
        drawChart();
    });
}

// 页面加载完成后初始化
window.onload = init;
</script>
</body>
</html>